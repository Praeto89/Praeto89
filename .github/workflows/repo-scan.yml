name: Repo Scan

on:
  schedule:
    - cron: "15 5 * * *"  # daily 05:15 UTC
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  scan:
    runs-on: ubuntu-latest
    concurrency:
      group: repo-scan-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: Ensure gh and jq are available
        run: |
          gh --version
          jq --version

      - name: Fetch repositories
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN_REPOS }}
        run: |
          gh api /user/repos \
            --paginate \
            --jq '.[] | {full_name, private, archived, pushedAt}' \
            > repos.ndjson

          # Build JSON array from ndjson for artifact and reporting
          jq -s '.' repos.ndjson > repos.json

      - name: Summarize
        run: |
          total=$(jq 'length' repos.json)
          private=$(jq '[.[] | select(.private == true)] | length' repos.json)
          archived=$(jq '[.[] | select(.archived == true)] | length' repos.json)
          active=$(jq '[.[] | select(.archived != true)] | length' repos.json)

          echo "total=$total" >> $GITHUB_OUTPUT
          echo "private=$private" >> $GITHUB_OUTPUT
          echo "archived=$archived" >> $GITHUB_OUTPUT
          echo "active=$active" >> $GITHUB_OUTPUT

          # Build markdown table sorted by last push desc
          jq -r '.[] | "| \(.full_name) | \(.private) | \(.archived) | \(.pushedAt//" - ") |"' repos.json | sort -k 5 -r > report_rows.txt
          {
            echo "| Repo | Private | Archived | Last Push |"
            echo "| --- | --- | --- | --- |"
            cat report_rows.txt
          } > report.md

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: repo-scan-report
          path: |
            repos.json
            report.md

      - name: Create daily issue report
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN_REPOS }}
          REPO: ${{ github.repository }}
        run: |
          total=$(jq 'length' repos.json)
          private=$(jq '[.[] | select(.private == true)] | length' repos.json)
          archived=$(jq '[.[] | select(.archived == true)] | length' repos.json)
          active=$(jq '[.[] | select(.archived != true)] | length' repos.json)

          today=$(date -u +"%Y-%m-%d")
          title="Daily repo scan ${today}"

          {
            echo "Repo scan summary:"
            echo "- Total repos: ${total}"
            echo "- Private repos: ${private}"
            echo "- Archived repos: ${archived}"
            echo "- Active (non-archived): ${active}"
            echo
            echo "Detailed list (sorted by last push):"
            cat report.md
          } > issue_body.md

          gh issue create \
            --repo "${REPO}" \
            --title "${title}" \
            --body-file issue_body.md
